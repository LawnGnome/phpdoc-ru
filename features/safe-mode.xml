<?xml version="1.0" encoding="utf-8"?>
<!-- $Revision: 1.5 $ -->
<!-- EN-Revision: 1.57 Maintainer: young Status: ready -->
 <chapter xml:id="features.safe-mode" xmlns="http://docbook.org/ns/docbook">
  <title>Защищенный режим</title>

  <para>
   Защищенный режим в PHP - это попытка решить проблему безопасности на совместно 
   используемых серверах. Несмотря на то, что концептуально неверно решать 
   эту проблему на уровне PHP, но поскольку альтернативы уровня веб-сервера или
   операционной системы на сегодняшний день отсутствуют, многие пользователи,
   особенно провайдеры, используют именно защищенный режим.
  </para>

  <sect1 xml:id="ini.sect.safe-mode">
   <title>Безопасность и защищенный режим</title>
   <para>
    <table>
     <title>Конфигурационные опции, управляющие защищенным режимом и вопросами безопасности</title>
     <tgroup cols="3">
      <thead>
       <row>
        <entry>Имя</entry>
        <entry>Значение по умолчанию</entry>
        <entry>Изменяемость</entry>
       </row>
      </thead>
      <tbody>
      <row>
       <entry>safe_mode</entry>
       <entry>"0"</entry>
       <entry>PHP_INI_SYSTEM</entry>
      </row>
      <row>
       <entry>safe_mode_gid</entry>
       <entry>"0"</entry>
       <entry>PHP_INI_SYSTEM</entry>
      </row>
      <row>
       <entry>safe_mode_include_dir</entry>
       <entry>NULL</entry>
       <entry>PHP_INI_SYSTEM</entry>
      </row>
      <row>
       <entry>safe_mode_exec_dir</entry>
       <entry>""</entry>
       <entry>PHP_INI_SYSTEM</entry>
      </row>
      <row>
       <entry>safe_mode_allowed_env_vars</entry>
       <entry>PHP_</entry>
       <entry>PHP_INI_SYSTEM</entry>
      </row>
      <row>
       <entry>safe_mode_protected_env_vars</entry>
       <entry>LD_LIBRARY_PATH</entry>
       <entry>PHP_INI_SYSTEM</entry>
      </row>
      <row>
       <entry>open_basedir</entry>
       <entry>NULL</entry>
       <entry>PHP_INI_SYSTEM</entry>
      </row>
      <row>
       <entry>disable_functions</entry>
       <entry>""</entry>
       <entry>PHP_INI_SYSTEM</entry>
      </row>
      <row>
       <entry>disable_classes</entry>
       <entry>""</entry>
       <entry>PHP_INI_SYSTEM</entry>
      </row>
      </tbody>
     </tgroup>
    </table> 
    Для получения более детальной информации о константах вида  PHP_INI_* 
    ознакомьтесь с функцией <function>ini_set</function>.
   </para>
   
   &ini.descriptions.title;
   
   <para>
    <variablelist>
     <varlistentry xml:id="ini.safe-mode">
      <term>
       <parameter>safe_mode</parameter>
       <type>boolean</type>
      </term>
      <listitem>
       <para>
        Включает/отключает защищенный режим в PHP. Для получения более
        детальной информации ознакомьтесь с разделом <link linkend="security.index">Безопасность</link>.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry xml:id="ini.safe-mode-gid">
      <term>
       <parameter>safe_mode_gid</parameter>
       <type>boolean</type>
      </term>
      <listitem>
       <para>
        По умолчанию в защищенном режиме при открытии файла выполняется
        проверка значения UID. Для того, чтобы немного смягчить это условие и
        выполнять проверку GID, необходимо установить значение on для флага safe_mode_gid.
        Определяет, использовать или нет проверку <literal>UID</literal> (&false;) или
        <literal>GID</literal> (&true;) проверку при обращении к файлу.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry xml:id="ini.safe-mode-include-dir">
      <term>
       <parameter>safe_mode_include_dir</parameter>
       <type>string</type>
      </term>
      <listitem>
       <para>
        При подключении файлов, расположенных в указанной директории и всех ее подкаталогах,
        проверка на соответствие значений <literal>UID</literal>/<literal>GID</literal> 
        не выполняется (В случае, если установленная директория не указана в <link linkend="ini.include-path">include_path</link>,
        необходимо указывать полный путь при включении).
       </para>
       <simpara>
        Начиная с PHP 4.2.0 значением этой директивы может быть список каталогов,
        разделенных двоеточием (точкой с запятой на windows-системах), что аналогично
        синтаксису <link linkend="ini.include-path">include_path</link>. 
       </simpara>
       <simpara>
        Указанное значение в действительности является префиксом, а не названием
        директории. Это означает, что запись
        "safe_mode_include_dir = /dir/incl" позволяет подключать файлы, находящиеся
        в директориях "/dir/include" и "/dir/incls", в случае, если они существуют. 
        Если вы хотите указать доступ к конкретной директории, используйте завершающий слеш, например:
	 "safe_mode_include_dir = /dir/incl/".
       </simpara>
      </listitem>
     </varlistentry>
     <varlistentry xml:id="ini.safe-mode-exec-dir">
      <term>
       <parameter>safe_mode_exec_dir</parameter>
       <type>string</type>
      </term>
      <listitem>
       <para>
        В случае, когда PHP работает в защищенном режиме,
        <function>system</function> и другие <link linkend="ref.exec">функции
        для выполнения системных команд и программ</link>
        отклоняют выполнение программ, находящихся вне данной директории.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry xml:id="ini.safe-mode-allowed-env-vars">
      <term>
       <parameter>safe_mode_allowed_env_vars</parameter>
       <type>string</type>
      </term>
      <listitem>
       <para>
        Возможность устанавливать переменные окружения - потенциальная 
        брешь в безопасности. Значением этой директивы является
        список префиксов, разделенных двоеточиями. В защищенном режиме
        пользователь может модифицировать только те переменные окружения,
        имена которых начинаются с одного из указанных префиксов. По умолчанию,
        пользователю доступны переменные, которые начинаются с префикса PHP_ 
        (например, PHP_FOO=BAR).
       </para>
       <note>
        <para>
         В случае, если этой директиве указать пустое значение, пользователь получит
         возможность модифицировать любую переменную окружения!
        </para>
       </note>
      </listitem>
     </varlistentry>
     <varlistentry xml:id="ini.safe-mode-protected-env-vars">
      <term>
       <parameter>safe_mode_protected_env_vars</parameter>
       <type>string</type>
      </term>
      <listitem>
       <para>
        Эта директива содержит список переменных окружения, разделенных двоеточием,
        значение которых пользователь не сможет изменить, используя
        функцию <function>putenv</function>. Значения этих переменных
        остаются защищенными, даже если их модификация разрешена
        директивой safe_mode_allowed_env_vars.
       </para>
      </listitem>
     </varlistentry>
      <varlistentry xml:id="ini.open-basedir">
      <term>
       <parameter>open_basedir</parameter>
       <type>string</type>
      </term>
      <listitem>
       <para>
        Ограничивает список файлов, которые могут быть открыты в PHP,
        указанным деревом директорий <emphasis>независимо</emphasis> от
        того, используется защищенный режим или нет.
       </para>
       <para>
        Каждый раз, когда скрипт пытается открыть файл, например, при помощи
        функции <function>fopen</function> или <function>gzopen</function>,
        проверяется месторасположение файла. В случае, если он находится
        вне указанного дерева директорий, PHP отказывает в открытия файла.
        Все символические ссылки распознаются и преобразуются, поэтому обойти
        это ограничение при помощи символических ссылок невозможно.
       </para>
       <para>
        Специальное значение <constant>.</constant>
        указывает, что базовой следует считать директорию, в которой расположен
        сам скрипт. В этом случае следует быть осторожным, так как рабочую
		директорию скрипта можно легко изменить при помощи функции <function>chdir</function>.  
         </para>  
         <para>  
         Опция open_basedir может быть отключена в конфигурационном файле
		  <filename>httpd.conf</filename> (например, для некоторых виртуальных хостов)
          <link linkend="configuration.changes.apache">точно таким же образом</link> 
		  как и любая другая директива: "php_admin_value open_basedir none".  
       </para>
       <para>
        Для Windows-систем разделителем списка директорий служит точка с 
        запятой. Для всех других операционных систем в качестве разделителя
        используется двоеточие. В случае, если PHP работает как модуль веб-сервера
        Apache, все указания open_basedir для родительских директорий наследуются.
       </para>
       <para>
        Указанное значение в действительности является префиксом, а не названием
        директории. Это означает, что запись
        "safe_mode_include_dir = /dir/incl" позволяет открывать файлы, находящиеся
        в директориях "/dir/include" и "/dir/incls", в случае, если они существуют. 
        Если вы хотите указать доступ к конкретной директории, используйте завершающий слеш, например:
	 "safe_mode_include_dir = /dir/incl/".
       </para>
       <note>
        <para>
         Возможность работы с несколькими директориями добавлена в версии  3.0.7.
        </para>
       </note>
       <para>
        По умолчанию разрешен доступ ко всем файлам.
       </para>
      </listitem>
     </varlistentry>
     <varlistentry xml:id="ini.disable-functions">
      <term>
       <parameter>disable_functions</parameter>
       <type>string</type>
      </term>
      <listitem>
       <simpara>
        Эта директива позволяет вам запретить некоторые функции из
        соображений  <link linkend="security.index">безопасности</link>.
        В качестве значения она принимает список функций, разделенных двоеточием.
	disable_functions не зависит от того, используется <link linkend="ini.safe-mode">Защищенный режим</link> или нет.
       </simpara>
       <simpara>
        Эта директива должна быть указана в &php.ini;. Вы не можете использовать
        ее, например, в &httpd.conf;.
       </simpara>
      </listitem>
     </varlistentry>
     <varlistentry xml:id="ini.disable-classes">
      <term>
       <parameter>disable_classes</parameter>
       <type>string</type>
      </term>
      <listitem>
       <simpara>
        Эта директива позволяет вам запретить некоторые классы из
        соображений  <link linkend="security.index">безопасности</link>. 
        В качестве значения она принимает список класов, разделенных двоеточием.
	disable_classes не зависит от того, используется <link linkend="ini.safe-mode">Защищенный режим</link> или нет.
       </simpara>
       <simpara>
        Эта директива должна быть указана в &php.ini;. Вы не можете использовать
        ее, например, в &httpd.conf;.
       </simpara>
       <note>
        <para>
        Эта директива доступна, начиная с PHP 4.3.2
        </para>
       </note>
      </listitem>
     </varlistentry>
    </variablelist>
   </para>
   <para>
    Ознакомьтесь также со следующими конфигурационными директивами: 
    <link linkend="ini.register-globals">register_globals</link>,
    <link linkend="ini.display-errors">display_errors</link>, и
    <link linkend="ini.log-errors">log_errors</link>
   </para>

  <para>
   В случае, если директива <link linkend="ini.safe-mode">safe_mode</link> 
   установлена значением on, PHP проверит, совпадает ли владелец скрипта и 
   владелец файла или директории, которыми оперирует скрипт. Например:
   <programlisting role="ls">
<![CDATA[
-rw-rw-r--    1 rasmus   rasmus       33 Jul  1 19:20 script.php 
-rw-r--r--    1 root     root       1116 May 26 18:01 /etc/passwd 
]]>
   </programlisting>
   выполние срипта script.php 
   <programlisting role="php">
<![CDATA[
<?php
 readfile('/etc/passwd'); 
?>
]]>
   </programlisting>
   в случае использования защищенного режима приводит к следующей ошибке:
   <screen>
<![CDATA[
Warning: SAFE MODE Restriction in effect. The script whose uid is 500 is not 
allowed to access /etc/passwd owned by uid 0 in /docroot/script.php on line 2
]]>
   </screen>
  </para>
  <para>
   Тем не менее, предусмотрена возможность вместо проверки на соответствие
   <literal>UID</literal> использовать более мягкую проверку на соответствие
   <literal>GID</literal>. Для этого необходимо использовать директиву
   <link linkend="ini.safe-mode-gid">safe_mode_gid</link>. В случае, если она
   установлена значением  <literal>On</literal>, используется более мягкая 
   проверка <literal>GID</literal>. В противном случае, если установлено значение 
   <literal>Off</literal> (значение по умолчанию), выполняется более строгая проверка
   на соответствие <literal>UID</literal>.
  </para>
  <para>
   В качестве альтернативы директиве <link linkend="ini.safe-mode">safe_mode</link> 
   вы можете ограничить все выполняемые скрипты жестко заданным
   деревом директорий при помощи опции <link linkend="ini.open-basedir">open_basedir</link>.
   Например (фрагмент конфигурационного файла &httpd.conf;): 
   <programlisting role="ini">
<![CDATA[
<Directory /docroot>
  php_admin_value open_basedir /docroot 
</Directory>
]]>
   </programlisting>
   При попытке выполнить тот же самый скрипт script.php с 
   указанной опцией 
   <link linkend="ini.open-basedir">open_basedir</link>
   вы получите следующий результат:
   <screen>
<![CDATA[
Warning: open_basedir restriction in effect. File is in wrong directory in 
/docroot/script.php on line 2 
]]>
   </screen>
  </para>
  <para>
   Вы также можете запретить отдельные функции. Следует заметить, что 
   директива 
   <link linkend="ini.disable-functions">disable_functions</link>
   может быть указана исключительно в конфигурационном файле &php.ini;,
   это означает, что вы не можете, отредактировав &httpd.conf;, установить 
   индивидуальные значения для конкретного виртуального хоста или каталога.
   Если добавить в &php.ini; следующую строку: 
   <programlisting role="ini">
<![CDATA[
disable_functions readfile,system  
]]>
   </programlisting>
  Результатом работы скрипта будет следующий вывод: 
   <screen>
<![CDATA[
Warning: readfile() has been disabled for security reasons in 
/docroot/script.php on line 2 
]]>
   </screen>
  </para>
 </sect1>

  <sect1 xml:id="features.safe-mode.functions">
   <title>Ограниченные или недоступные в защищенном режиме функции</title>
   <para>
    Ниже приведен, вероятно, неполный и, возможно, не вполне корректный список
    функций, ограниченных в 
    <link linkend="features.safe-mode">защищенном режиме</link>.
    <!-- TODO: add &note.sm.*; to the functions mentioned here.
    That entity should link to this section -->
    <table>
     <title>Функции, ограниченные в безопасном режиме</title>
     <tgroup cols="2">
      <thead>
       <row>
        <entry>Функция</entry>
        <entry>Ограничения</entry>
       </row>
      </thead>
      <tbody>
       <row>
        <entry><function>dbmopen</function></entry>
        <entry>&sm.uidcheck;</entry>
       </row>
       <row>
        <entry><function>dbase_open</function></entry>
        <entry>&sm.uidcheck;</entry>
       </row>
       <row>
        <entry><function>filepro</function></entry>
        <entry>&sm.uidcheck;</entry>
       </row>
       <row>
        <entry><function>filepro_rowcount</function></entry>
        <entry>&sm.uidcheck;</entry>
       </row>
       <row>
        <entry><function>filepro_retrieve</function></entry>
        <entry>&sm.uidcheck;</entry>
       </row>
       <row>
        <entry>ifx_*</entry>
        <entry>sql_safe_mode ограничения (не путать с safe_mode)</entry>
        <!-- TODO: more info on sql-safe-mode -->
       </row>
       <row>
        <entry>ingres_*</entry>
        <entry>sql_safe_mode ограничения (не путать с safe_mode)</entry>
        <!-- TODO: more info on sql-safe-mode -->
       </row>
       <row>
        <entry>mysql_*</entry>
        <entry>sql_safe_mode ограничения (не путать с safe_mode)</entry>
        <!-- TODO: more info on sql-safe-mode -->
       </row>
       <row>
        <entry><function>pg_lo_import</function></entry>
        <entry>&sm.uidcheck;</entry>
        <!-- source TODO: there is no PHP-warning for that safe-mode-restriction -->
       </row>
       <row>
        <entry><function>posix_mkfifo</function></entry>
        <entry>&sm.uidcheck.dir;</entry>
       </row>
       <row>
        <entry><function>putenv</function></entry>
        <entry>Подчиняется настройкам the safe_mode_protected_env_vars и
        safe_mode_allowed_env_vars. Ознакомьтесь с более подробным описанием
        функции <function>putenv</function>.</entry>
        <!-- TODO: document those directives in chapters/config.xml -->
       </row>
       <row>
        <entry><function>move_uploaded_file</function></entry>
        <entry>&sm.uidcheck; <!-- TODO: check this --></entry>
       </row>

       <!-- TODO: from here on, add warning to the function itself -->

       <row>
        <entry><function>chdir</function></entry>
        <entry>&sm.uidcheck.dir;</entry>
       </row>
       <row>
        <entry><function>dl</function></entry>
        <entry>&sm.disabled;</entry>
       </row>
       <row>
        <entry><link linkend="language.operators.execution">backtick operator</link></entry>
        <entry>&sm.disabled;</entry>
       </row>
       <row>
        <entry><function>shell_exec</function> (функция эквивалентна backticks)</entry>
        <entry>&sm.disabled;</entry>
       </row>
       <row>
        <entry><function>exec</function></entry>
        <entry>Вы можете запускать исполняемые файлы, ограниченные деревом
        каталогов, указанным в <link linkend="ini.safe-mode-exec-dir">safe_mode_exec_dir</link>.
        Исходя из практических соображений, использовать <literal>..</literal> 
        при указании пути запрещено. Следует заметить, что к аргументу этой функции
		применяется <function>escapeshellcmd</function>.
        </entry>
       </row>
       <row>
        <entry><function>system</function></entry>
        <entry>Вы можете запускать исполняемые файлы, ограниченные деревом
        каталогов, указанным в <link linkend="ini.safe-mode-exec-dir">safe_mode_exec_dir</link>.
        Исходя из практических соображений, использовать <literal>..</literal> 
        при указании пути запрещено. Следует заметить, что к аргументу этой функции
		применяется <function>escapeshellcmd</function>
        </entry>
       </row>
       <row>
        <entry><function>passthru</function></entry>
        <entry>Вы можете запускать исполняемые файлы, ограниченные деревом
        каталогов, указанным в <link linkend="ini.safe-mode-exec-dir">safe_mode_exec_dir</link>.
        Исходя из практических соображений, использовать <literal>..</literal> 
        при указании пути запрещено. Следует заметить, что к аргументу этой функции
		применяется <function>escapeshellcmd</function>.
        </entry>
       </row>
       <row>
        <entry><function>popen</function></entry>
        <entry>Вы можете запускать исполняемые файлы, ограниченные деревом
        каталогов, указанным в <link linkend="ini.safe-mode-exec-dir">safe_mode_exec_dir</link>.
        Исходя из практических соображений, использовать <literal>..</literal> 
        при указании пути запрещено. Следует заметить, что к аргументу этой функции
		применяется <function>escapeshellcmd</function>.
        </entry>
        <!-- TODO: not sure. popen uses a completely different implementation
        Don't know why, don't know whether it's behaving the same -->
       </row>
       <row>
        <entry><function>fopen</function></entry>
        <entry>&sm.uidcheck.dir;</entry>
       </row>
       <row>
        <entry><function>mkdir</function></entry>
        <entry>&sm.uidcheck.dir;</entry>
       </row>
       <row>
        <entry><function>rmdir</function></entry>
        <entry>&sm.uidcheck.dir;</entry>
       </row>
       <row>
        <entry><function>rename</function></entry>
        <entry>&sm.uidcheck; &sm.uidcheck.dir;<!-- on the old name only, it seems. Is rename preventing moving files? --></entry>
       </row>
       <row>
        <entry><function>unlink</function></entry>
        <entry>&sm.uidcheck; &sm.uidcheck.dir;</entry>
       </row>
       <row>
        <entry><function>copy</function></entry>
        <entry>&sm.uidcheck; &sm.uidcheck.dir; (Для
        параметров <parameter>source</parameter> и 
        <parameter>target</parameter>). </entry>
       </row>
       <row>
        <entry><function>chgrp</function></entry>
        <entry>&sm.uidcheck;</entry>
       </row>
       <row>
        <entry><function>chown</function></entry>
        <entry>&sm.uidcheck;</entry>
       </row>
       <row>
        <entry><function>chmod</function></entry>
        <entry>&sm.uidcheck; Кроме того, вы не можете
        устанавливать UID, SGID и sticky-биты.</entry>
       </row>
       <row>
        <entry><function>touch</function></entry>
        <entry>&sm.uidcheck; &sm.uidcheck.dir;</entry>
       </row>
       <row>
        <entry><function>symlink</function></entry>
        <entry>&sm.uidcheck; &sm.uidcheck.dir; 
        (Замечание: проверка выполняется только для параметра <parameter>target</parameter>)
        </entry>
       </row>
       <row>
        <entry><function>link</function></entry>
        <entry>&sm.uidcheck; &sm.uidcheck.dir; 
        (Замечание: проверка выполняется только для параметра <parameter>target</parameter>)
	</entry>
       </row>
       <row>
        <entry><function>apache_request_headers</function></entry>
        <entry>В защищенном режиме, заголовки, начинающиеся с 'authorization' 
        (независимо от регистра), не возвращаются.</entry>
       </row>
       <row>
        <entry><function>header</function></entry>
        <entry>В защищенном режиме, текущий UID  скрипта будет добавлен к
        <literal>realm</literal>-части заголовка
        <literal>WWW-Authenticate</literal>, если вы его устанавливаете
        (используется для HTTP-аутентификации)</entry>
       </row>
       <row>
        <entry><link linkend="features.http-auth">переменные PHP_AUTH</link></entry>
        <entry>
         В защищенном режиме, переменные <varname>PHP_AUTH_USER</varname>,
         <varname>PHP_AUTH_PW</varname>, и <varname>AUTH_TYPE</varname>
         недоступны как элементы массива <varname>$_SERVER</varname>. 
         Несмотря на это, вы все еще можете использовать переменную 
         <varname>REMOTE_USER</varname> для идентификации пользователя.
         (Замечание: актуально только для PHP 4.3.0 и выше)
        </entry>
       </row>
       <row>
        <entry>
         <function>highlight_file</function>,
         <function>show_source</function>
        </entry>
        <entry>
         &sm.uidcheck; &sm.uidcheck.dir; (Замечание: актуально только для PHP 4.2.1 и выше)
        </entry>
       </row>
       <row>
        <entry>
         <function>parse_ini_file</function>
        </entry>
        <entry>
         &sm.uidcheck; &sm.uidcheck.dir; (Замечание: актуально только для PHP 4.2.1 и выше)
        </entry>
       </row>
       <row>
        <entry>
         <function>set_time_limit</function>
        </entry>
        <entry>
         Не имеет никакого эффекта, если &safemode; используется
        </entry>
       </row>
       <row>
        <entry>
         <link linkend="ini.max-execution-time">max_execution_time</link>
        </entry>
        <entry>
         Не имеет никакого эффекта, если &safemode; используется
        </entry>
       </row>
       <row>
        <entry>
	 <function>mail</function>
	</entry>
	<entry>
	В защищенном режиме пятый параметр недоступен. 
	(Замечание: актуально только для PHP 4.2.3 и выше)
	</entry>
       </row>
       <row>
        <entry>Любая функция, которая использует
	 <filename>php4/main/fopen_wrappers.c</filename>
	</entry>
	<entry>Временно не документировано</entry>
       </row>
      </tbody>
     </tgroup>
    </table>
   </para>
  </sect1>

 </chapter>

<!-- Keep this comment at the end of the file
Local variables:
mode: sgml
sgml-omittag:t
sgml-shorttag:t
sgml-minimize-attributes:nil
sgml-always-quote-attributes:t
sgml-indent-step:1
sgml-indent-data:t
indent-tabs-mode:nil
sgml-parent-document:nil
sgml-default-dtd-file:"../../manual.ced"
sgml-exposed-tags:nil
sgml-local-catalogs:nil
sgml-local-ecat-files:nil
End:
vim600: syn=xml fen fdm=syntax fdl=2 si
vim: et tw=78 syn=sgml
vi: ts=1 sw=1
-->
