<?xml version="1.0" encoding="utf-8"?>
<!-- $Revision$ -->
<!-- EN-Revision: 336263 Maintainer: rjhdby Status: ready -->
<!-- Reviewed: no -->

<chapter xml:id="mongodb.tutorial.hhvm" xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink">
 <title>Работа с HHVM</title>
 
 <para>
  В этом разделе даются базовые знания о настройке связки NGINX, HHVM и MongoDB.
  Этот материал не является руководством, как настраивать и запускать
  NGINX и HHVM в промышленную эксплуатацию.
 </para>
 
 <para>
  В этом руководстве мы используем операционную систему Debian с
  установленным с помощью <code>apt-get</code> NGINX и HHVM,
  собранным из исходных кодов, либо установленным из пакета в
  директорию <code>/usr/local/hhvm/3.9.1</code> (сам исполняемый файл 
  расположен тут <code>/usr/local/hhvm/3.9.1/bin/hhvm</code>).
 </para>
 
 <section>
  <title>Установка NGINX</title>
  
  <para>
   Установим NGINX самым простым способом, с помощью команды
   <code>apt-get install nginx-full</code>.
   Если после установки NGINX не смог запуститься, то, скорее всего, это означает, что
   у вас уже установлен и запущен другой веб сервер (например Apache). В этом
   случае в логе <code>/var/log/nginx/error.log</code> появятся следующий строки:
  </para>
  
  <programlisting role="shell">
<![CDATA[
2015/09/29 10:19:27 [emerg] 22445#22445: bind() to 0.0.0.0:80 failed (98:Address already in use)
2015/09/29 10:19:27 [emerg] 22445#22445: bind() to [::]:80 failed (98: Address already in use)
]]>
  </programlisting>
  
  <para>
   Для решения этой проблемы просто смените порт по умолчанию для NGINX или Apache,
   остановите процесс Apache командой <code>service apache2 stop</code>, или же
   удалите его полностью - <code>apt-get remove apache2</code>.
  </para>
 </section>
 
 <section>
  <title>Установка HHVM</title>
  
  <para>
   Это руководство написано с точки зрения разработчика расширений, так что
   мы соберем HHVM из исходных кодов, что упростит разработку и гарантирует
   наличие отладочной информации. Тем не менее, если вы не хотите идти
   сложным путем, то чуваки из Facebook также предоставляют прекомпилированные
   пакеты, именно которые <emphasis>вы</emphasis> скорее всего захотите 
   использовать при развертывании боевых сред. Инструкции по установке
   этих пакетов читайте в
   <link xlink:href="&url.facebook.hhvm.prebuild;">HHVM Wiki</link>.
  </para>
  
  <para>
   Необходимо установить оба пакета, <code>hhvm</code>
   <emphasis>и</emphasis> <code>hhvm-dev</code>. Второй из них понадобится
   позже при компиляции расширения MongoDB HHVM.
  </para>
  
  <para>
   Если вы собираете HHVM из исходников, то вам будет нужно создать директорию
   <code>/var/run/hhvm</code>:
  </para>
  
  <programlisting role="shell">
<![CDATA[
sudo mkdir -p /var/run/hhvm
sudo chown www-data.www-data /var/run/hhvm
sudo mkdir /etc/hhvm
sudo touch /etc/hhvm/php.ini
# Следующая строка для того, чтобы для редактирования файла не использовать ``sudo``
sudo chown derick /etc/hhvm/php.ini
# Можно просто будет поступать таким образом
echo "date.timezone=Europe/London" >> /etc/hhvm/php.ini
]]>
  </programlisting>
  
  <para>
   HHVM должен запускаться из под пользователя <code>www-data</code>. 
   В этом руководстве мы запустим его на переднем плане в режиме
   <emphasis>server</emphasis>, таким образом:
  </para>
  
  <programlisting role="shell">
<![CDATA[
sudo -u www-data -s /usr/local/hhvm/3.9.1/bin/hhvm \
 --mode server \
 -vServer.Type=fastcgi \
 -vServer.FileSocket=/var/run/hhvm/sock
]]>
  </programlisting>
 </section>
 
 <section>
  <title>Подружим NGINX и HHVM</title>
  
  <para>
   Запустив HHVM, нам придется объяснить NGINX, как с ним взаимодействовать для
   запуска скриптов <code>.php</code>. Хотя это, пожалуй, не самый правильный 
   подход, но вы можете добавить следующий сниппет в
   <code>/etc/nginx/sites-enabled/default</code>, сразу за разделом
   <code>location / { … }</code>:
  </para>
  
  <programlisting role="conf">
<![CDATA[
location ~ \.php$ {
   fastcgi_pass unix:/var/run/hhvm/sock;
   fastcgi_index index.php;
   fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
   include fastcgi_params;
}
]]>
  </programlisting>
  
  <para>
   После добавления этого сниппета придется перезапустить NGINX:
  </para>
  
  <programlisting role="shell">
<![CDATA[
sudo service nginx restart
]]>
  </programlisting>
  
  <para>
   Для проверки, что все работает как надо, мы создадим директорию проекта,
   содержащую <code>index.php</code>, в котором будет только <code>phpinfo()</code>:
  </para>
  
  <para>
   <itemizedlist>
    <listitem>
     <para>
      Создаем директорию проекта:
      <code>sudo mkdir -p /var/www/html/my-first-project</code>
     </para>
    </listitem>
    <listitem>
     <para>
      Изменяем права доступа для вашего пользователя и группы <code>www-data</code>:
      <code>sudo chown derick.www-data /var/www/html/my-first-project</code>
     </para>
    </listitem>
    <listitem>
     <para>
      Создаем файл <code>/var/www/html/my-first-project/index.php</code>.
      С этого момента в руководсстве, для простоты, мы <emphasis>не</emphasis> включаем
      полный путь <code>/var/www/html/my-first-project/</code> при упоминании файлов.
      Добавляем в созданный файл следующие строки:
     </para>
     
     <programlisting role="php">
<![CDATA[
<?php
phpinfo();
?>
]]>
     </programlisting>
    </listitem>
   </itemizedlist>
  </para>
  
  <para>
   Теперь в вашем браузере обратитесь к этому файлу
   <code>http://gargleblaster/my-first-project/index.php</code> (только имя хоста
   поправьте). Должна появиться страница, начинающаяся с "HHVM Version 3.9.1" и
   содержащая несколько таблиц с информацией.
  </para>
 </section>
 
 <section>
  <title>Устанавливаем драйвер MongoDB для HHVM</title>
  
  <para>
   Драйвер MongoDB является связующим звеном между PHP в HHVM и
   базой данных. Для его установки и регистрации в HHVM вам понадобится
   воспользоваться инструкцией <xref linkend="mongodb.installation.hhvm"/>.
  </para>
  
  <para>
   После того, как вы установили и включили это расширение, потребуется
   перезапустить HHVM. Если HHVM работает на переднем плане (так, как мы его 
   запустили ранее), то просто остановите его с помощью Ctrl-C и запустите заново:
  </para>
  
  <programlisting role="shell">
<![CDATA[
sudo -u www-data -s /usr/local/hhvm/3.9.1/bin/hhvm \
   --mode server \
   -vServer.Type=fastcgi \
   -vServer.FileSocket=/var/run/hhvm/sock
]]>
  </programlisting>
  
  <para>
   Для проверки того, что драйвер загружен, замените содержимое
   <code>index.php</code> на:
  </para>
  
  <programlisting role="php">
<![CDATA[
<?php
var_dump(phpversion("mongodb"));
?>
]]>
  </programlisting>
  
  <para>Должно вывестить что-то подобное:</para>
  
  <programlisting role="text">
<![CDATA[
string(5) "x.y.z"
]]>
  </programlisting>
 </section>
 
 <section>
  <title>Что почитать дальше</title>
  
  <para>
   Продолжение этого руководство можно найти тут
   <xref linkend="mongodb.tutorial.library"/>.
  </para>
 </section>
</chapter>
<!-- Keep this comment at the end of the file
Local variables:
mode: sgml
sgml-omittag:t
sgml-shorttag:t
sgml-minimize-attributes:nil
sgml-always-quote-attributes:t
sgml-indent-step:1
sgml-indent-data:t
indent-tabs-mode:nil
sgml-parent-document:nil
sgml-default-dtd-file:"~/.phpdoc/manual.ced"
sgml-exposed-tags:nil
sgml-local-catalogs:nil
sgml-local-ecat-files:nil
End:
vim600: syn=xml fen fdm=syntax fdl=2 si
vim: et tw=78 syn=sgml
vi: ts=1 sw=1
-->
